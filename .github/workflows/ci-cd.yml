name: CI/CD Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # Syntax and style checks
  lint:
    name: Syntax & Style Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install linting tools
        run: |
          pip install ruff pyright

      - name: Check syntax with ruff
        run: |
          ruff check --select=E9,F63,F7,F82 --target-version=py311 .

      - name: Check import sorting
        run: |
          ruff check --select=I --target-version=py311 .
        continue-on-error: true

  # Type checking / compilation
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r server/requirements.txt
          pip install -r client/requirements.txt 2>/dev/null || true
          pip install pyright

      - name: Run type checker
        run: |
          # Check for type errors (exclude telegram_bot for now - needs separate cleanup)
          pyright server/main.py server/config.py server/schemas.py server/dependencies.py \
                  server/plug_service.py server/server_service.py server/power_service.py \
                  server/status_service.py client/homelab_client/

  # Run tests
  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r server/requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-mock requests

      - name: Run tests with coverage
        env:
          TAPO_USERNAME: test@example.com
          TAPO_PASSWORD: testpassword
          SSH_USER: testuser
          API_KEY: test-api-key
        run: |
          pytest client/tests/ \
            server/tests/test_schemas.py \
            server/tests/test_dependencies.py \
            server/tests/test_constants.py \
            server/tests/test_server_service.py \
            server/tests/test_plug_service.py \
            server/tests/test_config_unit.py \
            --cov=client --cov=server \
            --cov-report=xml \
            --cov-fail-under=50 \
            -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

  # Deploy to Raspberry Pi
  deploy:
    name: Deploy to RPI
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Install WireGuard
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard-tools

      - name: Setup WireGuard connection
        env:
          WG_PRIVATE_KEY: ${{ secrets.WG_PRIVATE_KEY }}
          WG_PEER_PUBLIC_KEY: ${{ secrets.WG_PEER_PUBLIC_KEY }}
          WG_ENDPOINT: ${{ secrets.WG_ENDPOINT }}
          WG_CLIENT_IP: ${{ secrets.WG_CLIENT_IP }}
          WG_ALLOWED_IPS: ${{ secrets.WG_ALLOWED_IPS }}
        run: |
          # Create WireGuard config
          sudo tee /etc/wireguard/wg0.conf > /dev/null << EOF
          [Interface]
          PrivateKey = ${WG_PRIVATE_KEY}
          Address = ${WG_CLIENT_IP}
          DNS = 10.0.8.10, fd80:ec75:cae:5455::a

          [Peer]
          PublicKey = ${WG_PEER_PUBLIC_KEY}
          Endpoint = ${WG_ENDPOINT}
          AllowedIPs = ${WG_ALLOWED_IPS}
          PersistentKeepalive = 25
          EOF

          sudo chmod 600 /etc/wireguard/wg0.conf
          sudo wg-quick up wg0

          # Verify connection
          sleep 2
          sudo wg show

      - name: Setup SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.RPI_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "${SSH_PRIVATE_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.RPI_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to Raspberry Pi
        env:
          RPI_HOST: ${{ secrets.RPI_HOST }}
          RPI_USER: ${{ secrets.RPI_USER }}
        run: |
          # Run deploy script
          ssh -o StrictHostKeyChecking=no ${RPI_USER}@${RPI_HOST} << 'ENDSSH'
            cd ~/lab-cli-py
            git pull -f
            cd ./docker
            
            ./deploy.sh
          ENDSSH

      - name: Teardown WireGuard
        if: always()
        run: |
          sudo wg-quick down wg0 || true
